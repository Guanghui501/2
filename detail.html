<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material Detail - Nemesis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.1/3Dmol-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #viewer {
            width: 600px;
            height: 600px;
            margin: auto;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info {
            max-width: 600px;
            margin: 30px auto;
            font-size: 18px;
            word-break: break-word;
            padding: 0 10px;
        }
        .info h2 {
            text-align: center;
            font-size: 26px;
            overflow-wrap: break-word;
        }
        #viewer-message {
            font-size: 16px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="info">
        <h2 id="formula">Loading...</h2>
        <p><strong>Energy:</strong> <span id="energy"></span> eV</p>
        <p><strong>Mass Density:</strong> <span id="density"></span> g/cm³</p>
        <p><strong>N Concentration:</strong> <span id="n_concentration"></span>%</p>
        <p><strong>Detonation Energy (E<sub>d</sub>):</strong> <span id="ed"></span> kJ/g</p>
        <p><strong>Detonation Velocity (V<sub>d</sub>):</strong> <span id="vd"></span> km/s</p>
        <p><strong>Detonation Pressure (P<sub>d</sub>):</strong> <span id="pd"></span> GPa</p>
    </div>

    <div id="viewer">
        <div id="viewer-message">Loading structure...</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        fetch('db.json')
            .then(response => response.json())
            .then(data => {
                const material = data[id];
                if (!material) {
                    document.getElementById('formula').innerText = "Material not found.";
                    document.getElementById('viewer-message').innerText = "No structure data.";
                    return;
                }

                document.getElementById('formula').innerText = material.formula;
                document.getElementById('energy').innerText = material.energy?.toFixed(3) ?? 'N/A';
                document.getElementById('density').innerText = material.mass_density?.toFixed(3) ?? 'N/A';
                document.getElementById('n_concentration').innerText = material.N_concentration?.toFixed(3) ?? 'N/A';
                document.getElementById('ed').innerText = material.E_d?.toFixed(3) ?? 'N/A';
                document.getElementById('vd').innerText = material.V_d?.toFixed(3) ?? 'N/A';
                document.getElementById('pd').innerText = material.P_d?.toFixed(3) ?? 'N/A';

                try {
                    const cif = generateCIF(material);
                    const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
                    viewer.addModel(cif, "cif");
                    viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
                    viewer.zoomTo();
                    viewer.render();

                    // 移除加载信息
                    const messageDiv = document.getElementById("viewer-message");
                    if (messageDiv) messageDiv.remove();
                } catch (err) {
                    console.error("3D structure rendering failed:", err);
                    document.getElementById('viewer-message').innerText = "Failed to load 3D structure.";
                }
            })
            .catch(err => {
                console.error("Data fetch error:", err);
                document.getElementById('formula').innerText = "Failed to load material data.";
                document.getElementById('viewer-message').innerText = "Failed to fetch structure.";
            });

        function generateCIF(data) {
            const { symbols, positions, cell } = data;
            const invCell = math.inv(cell);

            let cif = `data_material\n`;
            cif += `_cell_length_a   ${cell[0][0].toFixed(4)}\n`;
            cif += `_cell_length_b   ${cell[1][1].toFixed(4)}\n`;
            cif += `_cell_length_c   ${cell[2][2].toFixed(4)}\n`;
            cif += `_cell_angle_alpha  90\n_cell_angle_beta   90\n_cell_angle_gamma  90\n`;
            cif += `_symmetry_space_group_name_H-M   'P 1'\n`;
            cif += `_symmetry_Int_Tables_number   1\n\n`;
            cif += `_atom_site_label  _atom_site_type_symbol  _atom_site_fract_x  _atom_site_fract_y  _atom_site_fract_z\n`;

            for (let i = 0; i < symbols.length; i++) {
                const frac = math.multiply(invCell, positions[i]);
                cif += `${symbols[i]}${i + 1}  ${symbols[i]}  ${frac[0].toFixed(6)}  ${frac[1].toFixed(6)}  ${frac[2].toFixed(6)}\n`;
            }

            return cif;
        }
    </script>
</body>
</html>
